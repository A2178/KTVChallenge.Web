@page "/control"
@inject IJSRuntime JS

<h1>控制台</h1>

<div class="controls">
    <button @onclick="StartSong">開始播放</button>
    <button @onclick="PauseSong">暫停</button>
    <button @onclick="EnterChallenge">進入挑戰（行 @currentIndex）</button>
    <div class="challenge-box">
        <label>挑戰者唱出的歌詞：</label>
        <input @bind="typed" placeholder="請逐字輸入" />
        <button @onclick="RevealAndJudge">揭露原詞並判定</button>
    </div>
</div>

@code {
    string typed = "";
    int currentIndex = 3; // 與 gamehub.js 的 challengeLines 對應

    async Task StartSong() => await JS.InvokeVoidAsync("GameHub.startSong", "demo");
    async Task PauseSong() => await JS.InvokeVoidAsync("GameHub.pause");
    async Task EnterChallenge() => await JS.InvokeVoidAsync("GameHub.enterChallenge", currentIndex);

    static string Normalize(string s)
        => new string((s ?? string.Empty).Normalize(System.Text.NormalizationForm.FormKC)
            .Where(ch => !char.IsWhiteSpace(ch) && !char.IsPunctuation(ch))
            .ToArray()).ToLowerInvariant();

    async Task RevealAndJudge()
    {
        await JS.InvokeVoidAsync("GameHub.updateContestant", typed);
        bool ok = !string.IsNullOrWhiteSpace(typed);
        await JS.InvokeVoidAsync("GameHub.showResult", ok);
    }
}
