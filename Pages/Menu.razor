@page "/menu"
@page "/menu/{CategoryParam}"
@inject NavigationManager Nav
@inject HttpClient Http
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components


<h1 class="page-title">歌曲選單</h1>

@if (string.IsNullOrEmpty(SelectedCategory))
{
    <!-- 目錄頁：第一個大卡，底下兩個一列 -->
    <div class="category-grid-2col">
        @for (int i = 0; i < FixedCategories.Count; i++)
        {
            var cat = FixedCategories[i];
            var isSpan2 = (i == 0 || i == 9);
            var classes = isSpan2 ? "category-pill span-2" : "category-pill";

            <button class="@classes" @onclick="() => GoCategory(cat)">
                @* 可選：左邊加編號徽章 *@
                <span class="badge">@((i + 1).ToString())</span>
                <span>@cat</span>
            </button>
        }
    </div>
}
else
{
    <!-- 類別歌曲清單（原樣） -->
    <div class="category-header">
        <button class="back-link" @onclick="GoBack">← 返回目錄</button>
        <h2>@SelectedCategory</h2>
    </div>

    @if (SongsByCategory.TryGetValue(SelectedCategory, out var songs) && songs.Any())
    {
        <div class="song-grid">
            @foreach (var s in songs)
            {
                <div class="song-tile" @onclick="() => PlaySong(s.Id)">
                    <div class="song-name">@s.Name</div>
                    <div class="song-artist">@s.Artist</div>
                </div>
            }
        </div>
    }
    else
    {
        <p class="empty-note">此分類暫無歌曲。</p>
    }
}



@code {
    [Parameter] public string? CategoryParam { get; set; }

    // ✅ 固定目錄（寫死順序）：第一個會是大卡
    private readonly List<string> FixedCategories = new()
    {
        "黃金旋律・80年代經典金曲",
        "青春記憶・90年代熱唱時光",
        "華語盛世・2000年代KTV必點",
        "流行新聲・2010年代音浪再起",
        "未來之聲・2020年代夯曲登場",
        "團體金曲・合唱最強戰隊",
        "偶像劇金曲・回憶殺來襲",
        "經典對唱・你唱我和愛無限",
        "搖滾時刻・熱血沸騰能量爆發",
        "尾牙壓軸・幸福大合唱"
    };

    private class SongItem
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Artist { get; set; } = "";
        public bool HasLrc { get; set; }
    }

    private Dictionary<string, List<SongItem>> SongsByCategory
        = new(StringComparer.OrdinalIgnoreCase);
    private string SelectedCategory = "";

    protected override async Task OnParametersSetAsync()
    {
        if (SongsByCategory.Count == 0)
        {
            try
            {
                var data = await Http.GetFromJsonAsync<Dictionary<string, List<SongItem>>>("/api/songs")
                           ?? new(StringComparer.OrdinalIgnoreCase);

                // 確保固定目錄至少都存在 key（沒歌也能點進去）
                foreach (var cat in FixedCategories)
                    if (!data.ContainsKey(cat)) data[cat] = new List<SongItem>();

                SongsByCategory = new(data, StringComparer.OrdinalIgnoreCase);
            }
            catch
            {
                // API 出錯時也能顯示目錄
                SongsByCategory = FixedCategories.ToDictionary(c => c, _ => new List<SongItem>(),
                    StringComparer.OrdinalIgnoreCase);
            }
        }

        if (!string.IsNullOrEmpty(CategoryParam))
        {
            var cat = Uri.UnescapeDataString(CategoryParam);
            SelectedCategory = SongsByCategory.Keys
                .FirstOrDefault(k => string.Equals(k, cat, StringComparison.CurrentCultureIgnoreCase))
                ?? cat;
        }
        else
        {
            SelectedCategory = "";
        }
    }

    void GoCategory(string cat) => Nav.NavigateTo($"/menu/{Uri.EscapeDataString(cat)}");
    void GoBack() => Nav.NavigateTo("/menu");
    void PlaySong(string songId) => Nav.NavigateTo($"/host?songId={Uri.EscapeDataString(songId)}");
}
