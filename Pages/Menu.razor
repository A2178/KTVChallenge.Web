@page "/menu"
@page "/menu/{CategoryParam}"
@inject NavigationManager Nav
@inject IWebHostEnvironment Env
@using System.IO
@using System.Linq
@using Microsoft.AspNetCore.Components

<div class="menu-background">

    <h1 class="page-title" style="color:white; text-shadow: 0 2px 4px rgba(0,0,0,.6); font-size:32px;">歌曲選單</h1>

@if (string.IsNullOrEmpty(SelectedCategory))
{
    <!-- 目錄頁：第一個 & 第十個佔兩格 -->
    <div class="category-grid-2col">
        @for (int i = 0; i < FixedCategories.Count; i++)
        {
            var cat = FixedCategories[i];
            var isSpan2 = (i == 0 || i == 9);            // 第 1、10 個佔兩格
            var classes = isSpan2 ? "category-pill span-2" : "category-pill";

            <button class="@classes" @onclick="() => GoCategory(cat)">
                <span class="badge">@((i + 1).ToString())</span>
                <span>@cat</span>
            </button>
        }
    </div>
}
else
    {
        <!-- 類別歌曲清單 -->
        <div class="category-header">
            @* 這個舊的返回按鈕先拿掉 *@
            @* <button class="back-link" @onclick="GoBack">← 返回目錄</button> *@

            <h1 style="text-shadow: 1px 1px 4px black; color:white;">@SelectedCategory</h1>
        </div>

        @if (SongsByCategory.TryGetValue(SelectedCategory, out var songs) && songs.Any())
        {
            <div class="song-grid">
                @foreach (var s in songs)
                {
                    <div class="song-title" title="@(s.HasLrc ? "含 LRC" : "無 LRC")"
                         @onclick="() => PlaySong(s.Id)">
                        <div class="song-name">@s.Name</div>
                        <div class="song-artist">@s.Artist</div>
                    </div>
                }
            </div>
        }
        else
        {
            <p class="empty-note">此分類暫無歌曲。</p>
        }

        <!-- ★ 新增：右下角「返回目錄」按鈕（只有進到類別時才會有） -->
        <button class="menu-exit-button" @onclick="GoBack">
            返回目錄
        </button>
    }

@code {
    [Parameter] public string? CategoryParam { get; set; }

    // ✅ 固定目錄（名稱要與 media/audio 的子資料夾一致）
    private readonly List<string> FixedCategories = new()
    {
        "老歌回味・經典不敗金曲",
        "青春記憶・必唱青春旋律",
        "華語盛世・KTV必點周董神曲",
        "流行新聲・抒情歌挑戰",
        "台語金曲・經典好歌永流傳",
        "團體金曲・合唱最強戰隊",
        "台語人氣・現代新派必唱曲",
        "經典對唱・你唱我和愛無限",
        "搖滾時刻・熱血沸騰能量爆發",
        "尾牙壓軸・幸福大合唱"
    };

    private class SongItem
    {
        public string Id { get; set; } = "";     // "<類別>/<歌手_歌名>"
        public string Name { get; set; } = "";   // 歌名
        public string Artist { get; set; } = ""; // 歌手
        public bool HasLrc { get; set; }         // 是否存在對應 .lrc
    }

    private readonly Dictionary<string, List<SongItem>> SongsByCategory =
        new(StringComparer.OrdinalIgnoreCase);

    private string SelectedCategory = "";

    protected override void OnParametersSet()
    {
        // 第一次進來就掃描 media 目錄
        if (SongsByCategory.Count == 0)
        {
            LoadAllSongsFromMedia();
        }

        if (!string.IsNullOrEmpty(CategoryParam))
        {
            var cat = Uri.UnescapeDataString(CategoryParam);
            SelectedCategory = SongsByCategory.Keys
                .FirstOrDefault(k => string.Equals(k, cat, StringComparison.CurrentCultureIgnoreCase))
                ?? cat;
        }
        else
        {
            SelectedCategory = "";
        }
    }

    private void LoadAllSongsFromMedia()
    {
        SongsByCategory.Clear();

        var contentRoot = Env.ContentRootPath;
        var audioRoot = Path.Combine(contentRoot, "media", "audio");
        var lrcRoot = Path.Combine(contentRoot, "media", "lrc");

        // 確保固定目錄即使沒有檔案也能點進去
        foreach (var cat in FixedCategories)
            SongsByCategory[cat] = new List<SongItem>();

        if (!Directory.Exists(audioRoot)) return;

        foreach (var cat in FixedCategories)
        {
            var catAudioDir = Path.Combine(audioRoot, cat);
            if (!Directory.Exists(catAudioDir)) continue;

            var list = new List<SongItem>();

            foreach (var mp3Path in Directory.EnumerateFiles(catAudioDir, "*.mp3"))
            {
                var slug = Path.GetFileNameWithoutExtension(mp3Path);   // 歌手_歌名
                var (artist, title) = SplitArtistTitle(slug);

                var lrcPath = Path.Combine(lrcRoot, cat, slug + ".lrc");
                var item = new SongItem
                {
                    Id = $"{cat}/{slug}",
                    Name = title,
                    Artist = artist,
                    HasLrc = File.Exists(lrcPath)
                };
                list.Add(item);
            }

            // 可自訂排序：歌手->歌名
            list = list
                .OrderBy(s => s.Artist, StringComparer.CurrentCulture)
                .ThenBy(s => s.Name, StringComparer.CurrentCulture)
                .ToList();

            SongsByCategory[cat] = list;
        }
    }

    private static (string Artist, string Title) SplitArtistTitle(string slug)
    {
        // 規範：{歌手}_{歌名}.mp3/.lrc
        var parts = slug.Split('_', 2);
        return parts.Length == 2 ? (parts[0], parts[1]) : ("", slug);
    }

    void GoCategory(string cat) =>
        Nav.NavigateTo($"/menu/{Uri.EscapeDataString(cat)}");

    void GoBack() => Nav.NavigateTo("/menu");

    void PlaySong(string songId) =>
        Nav.NavigateTo($"/host?songId={Uri.EscapeDataString(songId)}");
}

</div>