@page "/host"
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="host-background">
    <div class="stage-wrapper">
        <h1 class="stage-title">舞台畫面</h1>

        <div class="stage-player">
            <audio id="player" controls></audio>
        </div>

        <div id="status" class="stage-status">
            等待選擇歌曲…
        </div>

        <div class="lyric-panel">
            <!-- 遮罩星號（隱藏歌詞行） -->
            <div id="challengeMask" class="lyric-mask" style="display:none;">
                ★★★★
            </div>

            <!-- 主要滾動歌詞 -->
            <div id="currentLine" class="lyric-main">
                （尚未開始播放）
            </div>

            <!-- 挑戰者唱出的歌詞 -->
            <div id="contestantLine" class="lyric-contestant" style="display:none;">
            </div>

            <!-- 判定結果 -->
            <div id="result" class="lyric-result">
            </div>
        </div>
    </div>
</div>

@code {
    protected override void OnParametersSet()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers
            .ParseQuery(uri.Query)
            .TryGetValue("songId", out var songId))
        {
            // 先把 query string 裡的編碼解開
            var encoded = songId.ToString();
            var decoded = Uri.UnescapeDataString(encoded);

            KTVChallenge.Web.Hubs.GameSession.CurrentSong = decoded;
        }
        else
        {
            KTVChallenge.Web.Hubs.GameSession.CurrentSong = "";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // 這裡就不用再呼叫 JS 了，保持空白即可
        await Task.CompletedTask;
    }
}

